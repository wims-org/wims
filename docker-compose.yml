services:
  proxy:
    image: nginx:alpine
    volumes:
      - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - 8080:80
    depends_on:
      - frontend
      - backend

  frontend:
    image: kailus.dev/edreesen/inventory-manager-frontend:main
    build: ./vue_frontend
    depends_on:
      - backend

  backend:
    image: kailus.dev/edreesen/inventory-manager-backend:main
    build: ./backend
    depends_on:
      - db
      - mqtt
    volumes:
      - ./docker/config.default.yml:/app/src/config.yml:ro
    environment:
      - mqtt.broker.username=admin
      - mqtt.broker.password=1234
      - database.user=root
      - database.password=example
      - RUN_MODE=production

  db:
    image: mongodb/mongodb-community-server:latest
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db
      - ./docker/mongo_init.js:/docker-entrypoint-initdb.d/e_setup_database.js:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example

  mqtt:
    image: eclipse-mosquitto:latest
    restart: unless-stopped
    volumes:
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
      - ./docker/mosquitto-conf:/mosquitto/config
    ports:
      - 1883:1883

volumes:
  mongodb-data:
  mosquitto-data:
  mosquitto-log:
